<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- displays site properly based on user's device -->

<link rel="icon" type="image/png" sizes="32x32" href="./images/favicon-32x32.png">
<link rel="stylesheet" href="styles.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet"> 
<!-- Подключаем leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
crossorigin=""/>
<!-- leaflet script code -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
crossorigin=""></script>

<title>Frontend Mentor | IP Address Tracker</title> 
</head>
<body>
  <main class="wrapper">
    <div class="top">
      <h1>IP Address Tracker</h1>
      <form id="form">
        <input id="adressInfo" type="text" placeholder="Search for any IP address or domain"/>
        <button class="searchBtn" type="submit">
          <!-- <svg xmlns="http://www.w3.org/2000/svg" width="11" height="14"><path fill="none" stroke="#FFF" stroke-width="3" d="M2 1l6 6-6 6"/></svg> -->
        </button>
      </form>
      <div class="ipInfo">
        <div class="ipInfo_part">
          <p class="ipInfo_partLabel">IP ADRESS</p>
          <p class="ipInfo_partText" id="ipAdress">No info</p>
        </div>
        <div class="ipInfo_part">
          <p class="ipInfo_partLabel">LOCATION</p>
          <p class="ipInfo_partText" id="location">No info</p>
        </div>
        <div class="ipInfo_part">
          <p class="ipInfo_partLabel">TIMEZONE</p>
          <p class="ipInfo_partText" id="timezone">No info</p>
        </div>
        <div class="ipInfo_part">
          <p class="ipInfo_partLabel">ISP</p>
          <p class="ipInfo_partText" id="isp">No info</p>
        </div>
      </div>
      
    </div>
    <div class="bottom">
      <div id="mapid"></div>
      <div class="attribution">
        Challenge by <a href="https://www.frontendmentor.io?ref=challenge" target="_blank">Frontend Mentor</a>. 
        Coded by <a href="#">Your Name Here</a>.
      </div>
    </div>
    
    
    
    
    
   
    
   
  </main>

  
  <script>
  
  // DOM elems
  const adressInput = document.getElementById('adressInfo');
  const button = document.querySelector('#form');
  const ipAdress = document.querySelector('#ipAdress');
  const city = document.querySelector('#location');
  const timezone = document.querySelector('#timezone');
  const isp = document.querySelector('#isp');


  // Events
  button.addEventListener('submit', (evt) => {
    
    const regex = /^\D+$/;
    let domain = '';
    console.log(adressInput);
    const apiKey = 'at_OQBifi7wE5UKnJSsAomiphaW9e9P9';
    let ipAdress = '';
    if (adressInput.value.startsWith(adressInput.value.match(regex))) {
      domain = adressInput.value;
    } else {
      ipAdress = adressInput.value;
    }
    const url = `https://geo.ipify.org/api/v1?apiKey=${apiKey}&ipAddress=${ipAdress}&domain=${domain}`
    getIp(url);
    evt.preventDefault();
  })
 
// API
// leaflet
// Подключаем карту, setView([lat, lon], zoom level)
const mymap = L.map('mapid').setView([0, 0], 5);

// Для копирайта
const attribution =  
    '&copy; Map data &copy; <a href="https://www.google.com/help/legalnotices_maps/">Google Maps</a> contributors';
const maxZoom = 20;
const subdomains = ['mt0','mt1','mt2','mt3'];

// АПИ карты (можно выбирать разные источники)
const tileUrl = 'http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}'
const tiles = L.tileLayer(tileUrl, {attribution, maxZoom, subdomains})
tiles.addTo(mymap);

// Делаем кастомную иконку маркера на карте
const myIcon = L.icon({
        iconUrl: 'images/icon-location.svg',
        });

// Ставим маркер по умолчанию (до выполнения функции по поиску коорд)
const marker = L.marker([0, 0], {icon: myIcon}).addTo(mymap);


// IP Geolocation API
    
async function getIp(url){
  console.log(url);
  const response = await fetch(url);
  const data = await response.json();
  console.log(data);
  let lat = data.location.lat;
  let lon = data.location.lng;
  console.log(lat,lon);

  // Ставим маркер там, где находится спутник после выполнения функции по поиску коорд. 
  marker.setLatLng([lat,lon]);
  mymap.setView([lat, lon],15);
  ipAdress.textContent = data.ip;
  city.textContent = data.location.city + ', ' + data.location.region + ' ' + data.location.postalCode;
  timezone.textContent = 'UTC' + data.location.timezone;
  isp.textContent = data.isp;

  };
  </script>
</body>
</html>